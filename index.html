<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Loteo del Valle — Lotes en Venta</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ✅ Panel / tabla / badges (TU CSS) -->
  <link rel="stylesheet" href="css/index.css"/>

  <style>
    /* Layout mínimo (el panel se diseña en index.css) */
    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; }
    body{
      font-family: "DM Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#0b0f14;
      overflow:hidden;
    }

    #map{
      position:fixed;
      inset:0;
    }

    /* Topbar flotante */
    .topbar{
      position: absolute;
      top: 10px; left: 10px; right: 10px;
      z-index: 1200;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.92);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
    }
    .brandMark{
      width: 34px; height: 34px;
      border-radius: 10px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.14);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
    }
    .brandTxt .t1{
      font-family: "Cormorant Garamond", serif;
      font-weight: 700;
      letter-spacing: .2px;
      line-height: 1.05;
      font-size: 18px;
    }
    .brandTxt .t2{
      font-size: 10px;
      opacity: .75;
      letter-spacing: .10em;
      text-transform: uppercase;
      margin-top: 2px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .tbtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
      user-select:none;
    }
    .tbtn:hover{ background: rgba(255,255,255,0.14); }
    .tbtn svg{ width:14px; height:14px; opacity:.9; }

    /* Leyenda */
    .legend{
      position:absolute;
      left: 12px;
      bottom: 12px;
      z-index: 1200;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.92);
      border-radius: 14px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      min-width: 220px;
    }
    .legend h4{
      margin:0 0 8px;
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      opacity: .78;
      font-weight: 800;
    }
    .legRow{
      display:flex; align-items:center; gap:10px;
      font-size: 12.5px;
      font-weight: 700;
      padding: 5px 0;
    }
    .dot{
      width: 14px; height: 10px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .dot.base{ border: 2px solid rgba(255,80,80,0.85); background: transparent; }

    /* ✅ Panel flotante (usa index.css para el estilo interno) */
    #infoPanel{
      position:absolute;
      right: 12px;
      top: 76px;           /* bajo la topbar */
      z-index: 1400;
      width: 360px;
      max-width: calc(100vw - 24px);
      display:none;        /* se abre al click */
    }
    #infoPanel.open{ display:block; }

    /* Botón cerrar dentro del header (mínimo, mantiene estética de index.css) */
    .info-close{
      position:absolute;
      right: 10px;
      top: 10px;
      width: 30px;
      height: 30px;
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(255,255,255,0.65);
      cursor:pointer;
      font-weight: 900;
      line-height: 1;
    }
    .info-close:hover{ filter: brightness(0.98); }

    /* Mobile: panel como sheet */
    @media (max-width: 720px){
      #infoPanel{
        left: 10px;
        right: 10px;
        top: auto;
        bottom: 10px;
        width: auto;
      }
    }

    /* Toast */
    #toast{
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 3000;
      background: rgba(0,0,0,0.72);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.92);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      opacity: 0;
      transform: translateY(-6px);
      transition: .18s ease;
      pointer-events:none;
      max-width: 360px;
    }
    #toast.show{ opacity:1; transform: translateY(0); }
  </style>

  <script>
    function showToast(msg) {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2200);
    }
  </script>
</head>

<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="brand">
      <div class="brandMark">⛰</div>
      <div class="brandTxt">
        <div class="t1">Loteo del Valle</div>
        <div class="t2">Atacama · Chile</div>
      </div>
    </div>

    <div class="actions">
      <div style="font-size:12px;opacity:.85;font-weight:700">
        <span id="countNum">—</span> lotes disponibles
      </div>

      <button class="tbtn" id="btnFit" title="Ajustar vista">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M1 5V2h3M12 2h3v3M15 11v3h-3M4 14H1v-3"/>
        </svg>
        Vista
      </button>

      <!-- Toggle manual: si el usuario elige OSM, queda fijo hasta volver a SAT -->
      <button class="tbtn" id="btnToggle" title="Cambiar mapa base">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8">
          <circle cx="8" cy="8" r="6.5"/>
          <path d="M8 1.5C8 1.5 11 5 11 8s-3 6.5-3 6.5"/>
          <path d="M8 1.5C8 1.5 5 5 5 8s3 6.5 3 6.5"/>
          <path d="M1.5 8h13"/>
        </svg>
        <span id="toggleLabel">OSM</span>
      </button>
    </div>
  </div>

  <div class="legend">
    <h4>Referencias</h4>
    <div class="legRow"><span class="dot" style="background:#5E9ED6"></span> En venta — MM$ 25</div>
    <div class="legRow"><span class="dot" style="background:#2DA882"></span> En venta — MM$ 30</div>
    <div class="legRow"><span class="dot" style="background:#D4882A"></span> En venta — MM$ 40</div>
    <div class="legRow"><span class="dot base"></span> Loteo base</div>
  </div>

  <!-- ✅ Ventana flotante (usa index.css) -->
  <aside id="infoPanel" class="info-panel" aria-live="polite">
    <div class="info-header" style="position:relative;">
      <div class="info-title">Información del lote</div>
      <div class="info-subtitle">Haz clic en un polígono del mapa</div>
      <button class="info-close" id="btnCloseInfo" title="Cerrar">×</button>
    </div>

    <div class="info-body">
      <div id="infoActions" style="display:none; margin-bottom: 10px; gap:8px;">
        <a id="btn-wa" class="btn btn-primary" href="#" target="_blank" rel="noopener">Consultar</a>
        <button id="btn-zoom" class="btn" type="button">Zoom</button>
      </div>

      <div id="infoTable">
        <div style="color: var(--muted); font-weight: 700; font-size: 13px;">
          Selecciona un lote para ver su ficha.
        </div>
      </div>
    </div>
  </aside>

  <div id="toast"></div>

  <script>
    /* =========================
       ✅ CARGA DESDE /capas/
       ========================= */

    const PATH_VENTA = "capas/lotes_en_venta.geojson";
    const PATH_BASE  = "capas/loteo_base.geojson";

    async function loadGeoJSON(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`${url}: HTTP ${r.status}`);
      const j = await r.json();
      if (!j || !j.type) throw new Error(`${url}: JSON inválido`);
      return j;
    }

    /* =========================
       MAP INIT (zoom libre)
       ========================= */
    const SAT_MAX_VISUAL_ZOOM = 16;   // <- regla que pediste
    const map = L.map("map", { zoomControl: true, maxZoom: 19 });
    map.zoomControl.setPosition("bottomright");

    const sat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19, attribution: "© Esri" }
    ).addTo(map);

    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom: 19, attribution: "© OpenStreetMap" }
    );

    // Estado del basemap:
    // - auto: SAT por defecto, si zoom > 16 => OSM, si vuelve <=16 => SAT
    // - osmLocked: usuario eligió OSM y se mantiene
    let baseMode = "auto"; // "auto" | "osmLocked"
    let currentBase = "sat"; // "sat" | "osm"

    function setBase(next){
      if (next === currentBase) return;

      if (next === "sat"){
        if (map.hasLayer(osm)) map.removeLayer(osm);
        if (!map.hasLayer(sat)) sat.addTo(map);
        currentBase = "sat";
        document.getElementById("toggleLabel").textContent = "OSM";
      } else {
        if (map.hasLayer(sat)) map.removeLayer(sat);
        if (!map.hasLayer(osm)) osm.addTo(map);
        currentBase = "osm";
        document.getElementById("toggleLabel").textContent = "SAT";
      }
    }

    function applyAutoBase(){
      if (baseMode !== "auto") return;
      const z = map.getZoom();
      if (z > SAT_MAX_VISUAL_ZOOM) setBase("osm");
      else setBase("sat");
    }

    map.on("zoomend", applyAutoBase);

    document.getElementById("btnToggle").onclick = () => {
      // Si estamos en auto y usuario pide OSM => lock
      if (baseMode === "auto"){
        baseMode = "osmLocked";
        setBase("osm");
        showToast("OSM seleccionado (fijo)");
        return;
      }

      // Si estaba fijo en OSM => volver a modo auto (y aplicar regla por zoom)
      baseMode = "auto";
      applyAutoBase();
      showToast("Modo automático (SAT/OSM por zoom)");
    };

    /* =========================
       STYLES
       ========================= */
    const buckets = { 25: "#5E9ED6", 30: "#2DA882", 40: "#D4882A" };
    function parseMM(v){
      const m = String(v || "").match(/(\d+)/);
      return m ? Number(m[1]) : null;
    }
    function styleVenta(f){
      const mm = parseMM(f.properties?.Valor);
      const color = buckets[mm] || "#5E9ED6";
      return { color, weight: 2.5, fillColor: color, fillOpacity: 0.38 };
    }
    function styleVentaSelected(f){
      const mm = parseMM(f.properties?.Valor);
      const color = buckets[mm] || "#5E9ED6";
      return { color, weight: 3.5, fillColor: color, fillOpacity: 0.62 };
    }

    /* =========================
       INFO PANEL (index.css)
       ========================= */
    const WA_NUMBER = "56985962740"; // <- tu número (sin +)

    function openInfo(feature, layer){
      const p = feature.properties || {};
      const mm = parseMM(p.Valor);
      const precio = p.Valor || (mm ? `MM$ ${mm}` : "—");

      const panel = document.getElementById("infoPanel");
      panel.classList.add("open");

      // Header panel
      document.querySelector("#infoPanel .info-title").textContent = p.Name || p.id || "Lote";
      document.querySelector("#infoPanel .info-subtitle").textContent =
        (p.id ? p.id + " · " : "") + (precio || "");

      // Actions
      const actions = document.getElementById("infoActions");
      actions.style.display = "flex";

      // Tabla
      const rows = [];
      const push = (k,v) => {
        if (v === undefined || v === null || String(v).trim()==="") return;
        rows.push(`<tr><th>${k}</th><td>${String(v)}</td></tr>`);
      };

      push("Referencia", p.id || "");
      push("Nombre", p.Name || "");
      push("Precio", p.Valor || "");
      for (const k in p){
        if (k === "id" || k === "Name" || k === "Valor") continue;
        const val = p[k];
        if (val && typeof val === "object") continue; // evita [object Object]
        push(k, val);
      }

      document.getElementById("infoTable").innerHTML = `
        <table>${rows.join("") || `<tr><th>Info</th><td>Sin datos</td></tr>`}</table>
      `;

      // WhatsApp
      const msg = encodeURIComponent(`Hola, me interesa el ${p.Name || "lote"} (${p.id || ""}) — Valor: ${p.Valor || ""}`);
      document.getElementById("btn-wa").href = `https://wa.me/${WA_NUMBER}?text=${msg}`;

      // Zoom (libre; si pasa 16 en auto => se cambia solo a OSM)
      document.getElementById("btn-zoom").onclick = () => {
        map.fitBounds(layer.getBounds().pad(0.3));
      };
    }

    function closeInfo(){
      const panel = document.getElementById("infoPanel");
      panel.classList.remove("open");

      if (window._selectedLayer){
        window._ventaLayer.resetStyle(window._selectedLayer);
        window._selectedLayer = null;
      }
    }

    document.getElementById("btnCloseInfo").onclick = (e) => {
      e.stopPropagation();
      closeInfo();
    };

    map.on("click", closeInfo);

    /* =========================
       INIT: cargar capas y dibujar
       ========================= */
    (async function init(){
      try{
        const [LOTES, BASE] = await Promise.all([
          loadGeoJSON(PATH_VENTA),
          loadGeoJSON(PATH_BASE),
        ]);

        // Contador
        document.getElementById("countNum").textContent = (LOTES.features || []).length;

        const baseLayer = L.geoJSON(BASE, {
          style: { color: "#ff5050", weight: 2, fillOpacity: 0, opacity: 0.65 },
          interactive: false
        }).addTo(map);

        window._selectedLayer = null;

        const ventaLayer = L.geoJSON(LOTES, {
          style: styleVenta,
          onEachFeature: (f, l) => {
            l.on("click", (e) => {
              L.DomEvent.stopPropagation(e);

              if (window._selectedLayer && window._selectedLayer !== l) ventaLayer.resetStyle(window._selectedLayer);
              window._selectedLayer = l;
              l.setStyle(styleVentaSelected(f));

              openInfo(f, l);
            });

            l.on("mouseover", function(){
              if (this !== window._selectedLayer) this.setStyle({ fillOpacity: 0.55, weight: 3 });
            });
            l.on("mouseout", function(){
              if (this !== window._selectedLayer) ventaLayer.resetStyle(this);
            });
          }
        }).addTo(map);

        window._ventaLayer = ventaLayer;

        const group = L.featureGroup([baseLayer, ventaLayer]);
        window._group = group;

        function fitView(){
          const b = group.getBounds();
          if (!b || !b.isValid()){
            showToast("No hay bounds válidos (revisa GeoJSON).");
            return;
          }
          map.fitBounds(b.pad(0.12));
          applyAutoBase();
        }

        document.getElementById("btnFit").onclick = () => {
          map.invalidateSize();
          fitView();
        };

        map.whenReady(() => {
          fitView();
          setTimeout(() => { map.invalidateSize(); }, 60);
        });

        window.addEventListener("load", () => {
          map.invalidateSize();
          fitView();
        });

      } catch (err){
        console.error(err);
        showToast("Error cargando capas. Revisa consola (F12).");
      }
    })();
  </script>
</body>
</html>
